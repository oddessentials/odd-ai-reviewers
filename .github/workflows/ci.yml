name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for tests using HEAD~1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Version is read from packageManager field in package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # FR-025: Verify toolchain versions match declared requirements
      - name: Verify toolchain versions
        run: |
          echo "Checking TypeScript version..."
          TS_VERSION=$(npx tsc --version | grep -oP '\d+\.\d+')
          echo "TypeScript version: $TS_VERSION"
          if [[ ! "$TS_VERSION" =~ ^5\.9 ]]; then
            echo "ERROR: TypeScript must be 5.9.x, got $TS_VERSION"
            exit 1
          fi
          echo "✓ TypeScript version OK"

          echo "Checking Vitest version..."
          VITEST_VERSION=$(npx vitest --version 2>/dev/null | head -1 | grep -oP '\d+' | head -1)
          echo "Vitest major version: $VITEST_VERSION"
          if [[ "$VITEST_VERSION" != "4" ]]; then
            echo "ERROR: Vitest must be 4.x, got major version $VITEST_VERSION"
            exit 1
          fi
          echo "✓ Vitest version OK"

      - name: Lint (zero-tolerance)
        run: pnpm lint --max-warnings 0

      - name: Format check
        run: pnpm format:check

      - name: Typecheck
        run: pnpm typecheck

      - name: Check circular dependencies
        run: pnpm depcruise

      # Guard: Ensure scripts have executable bit (prevents Windows->Linux issues)
      - name: Check script permissions
        run: ./scripts/check-executable-modes.sh

      # 011-agent-result-unions: Enforce discriminated union patterns
      - name: Check AgentResult patterns
        run: |
          ./scripts/check-success-ban.sh
          ./scripts/check-literal-ban.sh

      - name: Verify docs manifest
        run: |
          pnpm docs:manifest
          git diff --exit-code docs/viewer/manifest.json || (echo "Docs manifest is out of sync. Run 'pnpm docs:manifest' and commit." && exit 1)

      # FR-012: Documentation link integrity check
      # FR-013: External links require allowlist entry in .linkcheckignore.yml
      - name: Check documentation links
        run: pnpm docs:linkcheck

      # Spec-to-test traceability: Verify referenced test files exist
      - name: Check spec-to-test links
        run: pnpm spec:linkcheck

      - name: Build
        run: pnpm build

      # Install reviewdog for environment-gated integration tests
      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /usr/local/bin
          reviewdog -version

      # FR-005: Coverage thresholds enforced via vitest.config.ts
      # CI=true automatically triggers stricter thresholds
      - name: Test with coverage
        run: pnpm --filter ./router test:ci:coverage
        env:
          CI: 'true'
          CI_HAS_LSOF: 'true' # Ubuntu has lsof - enables socket detection tests
          CI_HAS_REVIEWDOG: 'true' # Installed above - enables reviewdog integration tests

      # FR-031: Upload test artifacts for badge-update workflow
      - name: Upload test artifacts
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            router/test-results.json
            router/coverage/coverage-summary.json
          retention-days: 1

      # FR-031: PR workflow does NOT depend on Gist availability
      # Badge updates are handled by separate badge-update.yml workflow

  # SC-004: Fresh clone test - verifies hooks auto-install and work correctly
  fresh-clone-test:
    name: Fresh Clone Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Fresh install (triggers husky prepare)
        run: pnpm install --frozen-lockfile

      - name: Verify husky hooks installed
        run: |
          test -f .husky/pre-commit || (echo "pre-commit hook not found" && exit 1)
          echo "✓ Husky hooks verified"

      - name: Test commit hook with unformatted file
        run: |
          # Create a deliberately unformatted TypeScript file
          # Use underscore-prefixed vars to satisfy ESLint no-unused-vars rule
          echo 'const _x=1;const _y=2;' > test-format.ts

          # Stage it
          git add test-format.ts

          # Configure git for commit
          git config user.email "test@example.com"
          git config user.name "Test User"

          # Attempt commit - lint-staged should auto-format
          git commit -m "test: verify formatting hook"

          # Verify commit succeeded
          echo "✓ Pre-commit hook executed successfully"

          # Verify no uncommitted changes (formatting was staged)
          git diff --exit-code test-format.ts || {
            echo "✗ File has unstaged changes after commit"
            exit 1
          }

          # Cleanup
          git reset --hard HEAD~1 2>/dev/null || git reset --hard HEAD
          rm -f test-format.ts

  # Cross-platform pnpm bin resolution test
  # Ensures ai-review binary is correctly linked on all supported platforms
  bin-resolution-test:
    name: pnpm Bin Resolution (${{ matrix.os }})
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runs-on: ubuntu-latest
          - os: macOS
            runs-on: macos-latest
          - os: Windows
            runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for cross-platform git tests

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build router
        run: pnpm build

      - name: Test pnpm bin resolution
        run: pnpm test:bin-resolution

      # T145: Cross-platform tests for local review mode
      # Invoke vitest directly: `pnpm test -- file.ts` passes args incorrectly,
      # causing vitest to run all tests instead of just the specified file.
      - name: Run cross-platform tests
        run: pnpm --filter ./router exec vitest run tests/integration/cross-platform.test.ts

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build router
        run: pnpm --filter ./router build

      - name: Build container image
        run: docker build -t odd-ai-reviewers-router:ci -f router/Dockerfile .

      - name: Reviewdog smoke test
        run: |
          # Verify reviewdog binary works by checking version
          # Must use --entrypoint to bypass the default node entrypoint
          docker run --rm --entrypoint reviewdog odd-ai-reviewers-router:ci -version
          # Run against sample diff (exit 0 = no findings, which is expected)
          docker run --rm -i --entrypoint reviewdog odd-ai-reviewers-router:ci \
            -f=diff -reporter=local < tests/fixtures/reviewdog-smoke.diff
          echo "Reviewdog smoke test passed"

      - name: Trivy scan (HIGH,CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: odd-ai-reviewers-router:ci
          format: table
          exit-code: '1'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
          trivyignores: .trivyignore

  # FR-006: Enforce conventional commit format on PR titles
  # Required for semantic-release version determination via squash-merge
  pr-title-validation:
    name: PR Title Validation
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'

    steps:
      # SHA-pinned for supply chain hardening (v5.5.3)
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@e32d7e603df1aa1ba07e981f2a23455dee596825
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # FR-016: Block manual CHANGELOG modifications
  # CHANGELOG.md is machine-owned, auto-generated by semantic-release
  changelog-protection:
    name: CHANGELOG Protection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CHANGELOG not modified
        run: |
          # Get list of changed files
          CHANGED=$(git diff --name-only origin/main...HEAD)

          # Check if CHANGELOG.md is in the list (root-level, managed by semantic-release)
          if echo "$CHANGED" | grep -q "^CHANGELOG.md$"; then
            echo "ERROR: CHANGELOG.md is machine-owned and cannot be modified in PRs."
            echo ""
            echo "The CHANGELOG is automatically generated by semantic-release."
            echo "Please revert your changes to CHANGELOG.md."
            echo ""
            echo "To add release notes, use the PR description - it will be included"
            echo "in the auto-generated changelog entry."
            exit 1
          fi

          echo "✓ CHANGELOG.md not modified"
