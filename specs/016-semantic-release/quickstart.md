# Quickstart: Automated npm Publishing with semantic-release

**Feature**: 016-semantic-release
**Date**: 2026-02-03

## Prerequisites

Before implementing this feature, ensure:

1. Repository is on GitHub with Actions enabled
2. npm organization/scope exists: `@oddessentials`
3. Branch protection is enabled on `main` branch
4. Existing commitlint setup (already present in this repo)

## One-Time Setup Steps

### 1. Create GitHub App (15 minutes)

1. Go to **Organization Settings** → **Developer settings** → **GitHub Apps** → **New GitHub App**

2. Configure the App:
   - **Name**: `odd-ai-reviewers-release-bot`
   - **Homepage URL**: `https://github.com/oddessentials/odd-ai-reviewers`
   - **Webhook**: Uncheck "Active" (not needed)
   - **Permissions**:
     - Repository permissions:
       - Contents: Read & write
       - Metadata: Read-only
       - Pull requests: Read-only
   - **Where can this App be installed?**: Only on this account

3. After creation:
   - Note the **App ID** (shown on App settings page)
   - Scroll to **Private keys** → **Generate a private key**
   - Save the downloaded `.pem` file securely

4. Install the App:
   - Go to **Install App** in left sidebar
   - Install on `oddessentials` organization
   - Select **Only select repositories** → choose `odd-ai-reviewers`

### 2. Configure GitHub Environment (5 minutes)

1. Go to **Repository Settings** → **Environments** → **New environment**

2. Create environment named: `release`

3. Configure environment protection:
   - **Deployment branches**: Selected branches → add `main`
   - Leave "Required reviewers" unchecked (automation shouldn't need approval)

4. Add environment secrets:
   - `APP_ID`: The App ID from step 1
   - `APP_PRIVATE_KEY`: Entire contents of the `.pem` file

### 3. Configure npm Token (5 minutes)

1. Go to [npmjs.com](https://www.npmjs.com) → **Access Tokens** → **Generate New Token**

2. Select **Automation** token type (for CI/CD)

3. Copy the token

4. Add to GitHub environment secrets:
   - Go to **Repository Settings** → **Environments** → **release** → **Environment secrets**
   - Add `NPM_TOKEN` with the token value

### 4. Configure Repository Settings (2 minutes)

1. Go to **Repository Settings** → **General** → **Pull Requests**

2. Under "Allow merge commits", "Allow squash merging", "Allow rebase merging":
   - **Uncheck**: Allow merge commits
   - **Check**: Allow squash merging
   - **Uncheck**: Allow rebase merging

3. This enforces squash-only merges (FR-013)

### 5. Update Branch Protection (2 minutes)

1. Go to **Repository Settings** → **Branches** → **main** protection rule

2. Ensure "Allow specified actors to bypass required pull requests" includes:
   - `odd-ai-reviewers-release-bot[bot]`

## Development Workflow

### For Contributors

1. **Create feature branch** from main
2. **Make changes** with any commit messages you like
3. **Open PR** with conventional commit title:
   ```
   feat: add new feature
   fix: resolve bug in X
   feat!: breaking change to API
   ```
4. **CI validates** PR title format automatically
5. **Squash merge** when approved (PR title becomes commit message)

### For Maintainers

1. **Review and approve** PRs as normal
2. **Merge** using squash merge (only option available)
3. **Release happens automatically**:
   - CI runs on main
   - semantic-release analyzes new commits
   - Version is determined automatically
   - CHANGELOG, tag, npm publish happen automatically
4. **Verify** release in GitHub Releases and npm

## Dry Run

To preview what would be released without actually releasing:

1. Go to **Actions** → **Release** workflow
2. Click **Run workflow**
3. Check **dry_run** checkbox
4. Click **Run workflow**
5. Check logs for "next release version would be X.Y.Z"

## Recovery from Failed Release

If a release fails partway through:

1. **Check workflow logs** to identify what failed
2. **Re-run the workflow** - semantic-release handles idempotent recovery:
   - If tag exists → skip tag creation
   - If npm version exists → skip publish
   - If CHANGELOG updated → skip changelog generation
3. **Post-release verification** confirms all artifacts match

## Troubleshooting

### PR Title Validation Failing

```
Error: PR title doesn't match conventional commit format
```

**Solution**: Update PR title to follow format: `type(scope): description`

- Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
- Scope is optional: `feat: add feature` or `feat(auth): add feature`

### CHANGELOG Modified Error

```
Error: CHANGELOG.md is machine-owned and cannot be modified in PRs
```

**Solution**: Revert changes to `router/CHANGELOG.md`. This file is automatically generated.

### Release Bot Can't Push

```
Error: refusing to allow a GitHub App to push
```

**Solution**:

1. Verify GitHub App is installed on repository
2. Check App has "Contents: write" permission
3. Verify branch protection allows the bot to bypass

### npm Publish Failed

```
Error: 403 Forbidden - You do not have permission to publish
```

**Solution**:

1. Verify npm token is valid and not expired
2. Check token has automation/publish permissions
3. Verify package name matches npm organization scope

### Version Mismatch in Verification

```
Error: Version mismatch detected
```

**Solution**: This indicates a partial failure. Check:

1. npm registry (may take a few minutes to propagate)
2. Git tags in repository
3. CHANGELOG.md content

If versions don't match, manual intervention may be required.

## Testing the Setup

After completing setup, test with a small change:

1. Create a branch: `git checkout -b test-release`
2. Make a trivial change (e.g., add comment to a file)
3. Commit: `git commit -m "test: verify release setup"`
4. Push and create PR with title: `chore: test release automation`
5. Merge the PR
6. Watch the release workflow run
7. Verify no release occurred (chore commits don't trigger releases)

Then test an actual release:

1. Create another branch
2. Make a real change
3. PR title: `feat: add release automation`
4. Merge
5. Verify release workflow creates tag, CHANGELOG entry, and npm publish
