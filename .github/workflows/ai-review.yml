# AI Review Reusable Workflow
# Callable via workflow_call from target repositories

name: AI Review

on:
  workflow_call:
    inputs:
      target_repo:
        description: 'Target repository (owner/repo)'
        required: true
        type: string
      target_ref:
        description: 'Git ref to checkout (SHA or branch)'
        required: true
        type: string
      pr_number:
        description: 'PR number (if applicable)'
        required: false
        type: number
      base_ref:
        description: 'Base ref for diff (defaults to main)'
        required: false
        type: string
        default: 'main'
      runs_on:
        description: 'Runner labels as JSON (e.g., "ubuntu-latest" or ["self-hosted","linux"])'
        required: false
        type: string
        default: '"ubuntu-latest"'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key (for opencode or pr_agent)'
        required: false
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key (for opencode with Claude models)'
        required: false
      AZURE_OPENAI_API_KEY:
        description: 'Azure OpenAI API key (requires ENDPOINT and DEPLOYMENT too)'
        required: false
      AZURE_OPENAI_ENDPOINT:
        description: 'Azure OpenAI endpoint URL'
        required: false
      AZURE_OPENAI_DEPLOYMENT:
        description: 'Azure OpenAI deployment name'
        required: false
      OLLAMA_BASE_URL:
        description: 'Ollama server URL for local LLM'
        required: false

jobs:
  ai-review:
    name: AI Code Review
    timeout-minutes: 30
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout review router
        uses: actions/checkout@v4
        with:
          repository: oddessentials/odd-ai-reviewers
          path: router

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_ref }}
          path: target
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: router/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: router/pnpm-lock.yaml

      - name: Install router dependencies
        working-directory: router
        run: pnpm install --frozen-lockfile

      - name: Build router
        working-directory: router
        run: pnpm build

      # Runtime smoke test - verify toolchain as actual job user
      - name: Verify toolchain
        run: |
          echo "=== Toolchain Smoke Test ==="
          echo "User: $(whoami)"
          echo "Shell: $SHELL"
          echo "PATH: $PATH"
          which semgrep 2>/dev/null && semgrep --version || echo "semgrep: will install"

      - name: Install Semgrep
        # Keep in sync with router/Dockerfile
        run: pip3 install semgrep==1.149.0

      - name: Determine base SHA
        id: base
        working-directory: target
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          INPUT_BASE_REF: ${{ inputs.base_ref }}
        run: |
          if [ -n "$PR_BASE_SHA" ]; then
            echo "sha=$PR_BASE_SHA" >> "$GITHUB_OUTPUT"
          else
            echo "sha=$(git rev-parse "origin/$INPUT_BASE_REF")" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate AI credentials
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$OLLAMA_BASE_URL" ] && [ -z "$AZURE_OPENAI_API_KEY" ]; then
            echo "::error::No AI credentials provided. Pass secrets with 'secrets: inherit' or map OPENAI_API_KEY, ANTHROPIC_API_KEY, AZURE_OPENAI_API_KEY, or OLLAMA_BASE_URL in the calling workflow."
            exit 1
          fi

      - name: Run AI Review
        working-directory: router
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
          INPUT_TARGET_REPO: ${{ inputs.target_repo }}
          INPUT_TARGET_REF: ${{ inputs.target_ref }}
          INPUT_PR_NUMBER: ${{ inputs.pr_number }}
          BASE_SHA: ${{ steps.base.outputs.sha }}
        run: |
          OWNER=$(echo "$INPUT_TARGET_REPO" | cut -d'/' -f1)
          REPO=$(echo "$INPUT_TARGET_REPO" | cut -d'/' -f2)

          PR_FLAG=""
          if [ -n "$INPUT_PR_NUMBER" ]; then
            PR_FLAG="--pr $INPUT_PR_NUMBER"
          fi

          node router/dist/main.js review \
            --repo ../target \
            --base "$BASE_SHA" \
            --head "$INPUT_TARGET_REF" \
            --owner "$OWNER" \
            --repo-name "$REPO" \
            $PR_FLAG

      - name: Upload review artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-results
          path: |
            router/review-*.json
            router/review-*.md
          retention-days: 7
