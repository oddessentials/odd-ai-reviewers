# AI Review Manual Dispatch Workflow
# Allows manual triggering of AI review on any repository

name: AI Review (Manual)

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (owner/repo)'
        required: true
        type: string
      target_ref:
        description: 'Git ref to review (SHA or branch)'
        required: true
        type: string
      base_ref:
        description: 'Base ref for diff'
        required: true
        type: string
        default: 'main'
      pr_number:
        description: 'PR number (optional, for posting comments)'
        required: false
        type: number

jobs:
  ai-review:
    name: Manual AI Review
    runs-on: ['self-hosted', 'linux']

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout review router
        uses: actions/checkout@v4

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_ref }}
          path: target
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build router
        run: pnpm --filter ./router build

      - name: Install Semgrep
        run: pip3 install semgrep

      - name: Get base SHA
        id: base
        working-directory: target
        env:
          BASE_REF: ${{ inputs.base_ref }}
        run: |
          echo "sha=$(git rev-parse "origin/$BASE_REF")" >> $GITHUB_OUTPUT

      - name: Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_REPO: ${{ inputs.target_repo }}
          TARGET_REF: ${{ inputs.target_ref }}
          BASE_SHA: ${{ steps.base.outputs.sha }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          OWNER=$(echo "$TARGET_REPO" | cut -d'/' -f1)
          REPO=$(echo "$TARGET_REPO" | cut -d'/' -f2)

          PR_ARG=""
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "0" ]; then
            PR_ARG="--pr $PR_NUMBER"
          fi

          node router/dist/main.js review \
            --repo target \
            --base "$BASE_SHA" \
            --head "$TARGET_REF" \
            --owner "$OWNER" \
            --repo-name "$REPO" \
            $PR_ARG

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-manual-${{ github.run_id }}
          path: |
            review-*.json
            review-*.md
          retention-days: 30
