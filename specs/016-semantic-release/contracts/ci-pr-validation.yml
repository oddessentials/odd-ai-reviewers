# Contract: PR Title Validation (addition to .github/workflows/ci.yml)
# This job should be added to the existing CI workflow

# Add this job to ci.yml
pr-title-validation:
  name: PR Title Validation
  runs-on: ubuntu-latest
  # Only run on pull requests
  if: github.event_name == 'pull_request'

  steps:
    # FR-006: Enforce conventional commit format on PR titles
    - name: Validate PR Title
      uses: amannn/action-semantic-pull-request@v5
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        requireScope: false
        subjectPattern: ^[A-Z].*$
        subjectPatternError: |
          The subject "{subject}" found in the PR title should start with an uppercase letter.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Add this job to ci.yml (runs on all PRs)
changelog-protection:
  name: CHANGELOG Protection
  runs-on: ubuntu-latest
  if: github.event_name == 'pull_request'

  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # FR-016: Block manual CHANGELOG modifications
    - name: Check CHANGELOG not modified
      run: |
        # Get list of changed files
        CHANGED=$(git diff --name-only origin/main...HEAD)

        # Check if CHANGELOG.md is in the list
        if echo "$CHANGED" | grep -q "^router/CHANGELOG.md$"; then
          echo "ERROR: router/CHANGELOG.md is machine-owned and cannot be modified in PRs."
          echo ""
          echo "The CHANGELOG is automatically generated by semantic-release."
          echo "Please revert your changes to router/CHANGELOG.md."
          echo ""
          echo "To add release notes, use the PR description - it will be included"
          echo "in the auto-generated changelog entry."
          exit 1
        fi

        echo "âœ“ CHANGELOG.md not modified"
