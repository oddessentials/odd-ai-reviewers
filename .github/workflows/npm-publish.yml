name: npm Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry-run publish (no actual publish)'
        required: false
        default: 'false'
        type: boolean
      version_override:
        description: 'Version override (leave empty to use package.json version)'
        required: false
        type: string

# Ensure only one publish runs at a time
concurrency:
  group: npm-publish
  cancel-in-progress: false

jobs:
  # Pre-publish quality gate - ensures code quality before publishing
  quality-gate:
    name: Quality Gate
    runs-on: [self-hosted, Linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint --max-warnings 0

      - name: Typecheck
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm --filter ./router test:ci
        env:
          CI: 'true'

  publish:
    name: Publish to npm
    runs-on: [self-hosted, Linux]
    needs: quality-gate
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # Verify package contents before publishing
      - name: Verify package contents
        working-directory: router
        run: |
          echo "=== Package contents preview ==="
          npm pack --dry-run 2>&1 | head -100

          echo ""
          echo "=== Verifying required files ==="

          # Check dist directory exists and has content
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found"
            exit 1
          fi

          if [ ! -f "dist/main.js" ]; then
            echo "ERROR: dist/main.js not found (entry point)"
            exit 1
          fi

          echo "✓ dist/main.js exists"

          # Check README exists
          if [ ! -f "README.md" ]; then
            echo "ERROR: README.md not found"
            exit 1
          fi

          echo "✓ README.md exists"

          # Verify package.json has required fields
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'bin', 'main', 'files', 'license'];
            const missing = required.filter(f => !pkg[f]);
            if (missing.length > 0) {
              console.error('ERROR: Missing required fields:', missing.join(', '));
              process.exit(1);
            }
            console.log('✓ All required package.json fields present');
            console.log('  name:', pkg.name);
            console.log('  version:', pkg.version);
            console.log('  bin:', JSON.stringify(pkg.bin));
          "

      # Version sync check (for releases)
      - name: Verify version matches release tag
        if: github.event_name == 'release'
        working-directory: router
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${GITHUB_REF_NAME#v}"

          echo "Package version: $PKG_VERSION"
          echo "Release tag version: $TAG_VERSION"

          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Package version ($PKG_VERSION) does not match release tag ($TAG_VERSION)"
            echo "Please update router/package.json version before creating the release."
            exit 1
          fi

          echo "✓ Version sync verified"

      # Override version if specified (manual dispatch only)
      - name: Apply version override
        if: github.event_name == 'workflow_dispatch' && inputs.version_override != ''
        working-directory: router
        run: |
          echo "Applying version override: ${{ inputs.version_override }}"
          npm version ${{ inputs.version_override }} --no-git-tag-version
          echo "✓ Version updated to ${{ inputs.version_override }}"

      # Dry run publish (for testing)
      - name: Publish (dry-run)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == 'true'
        working-directory: router
        run: |
          echo "=== DRY RUN - No actual publish ==="
          npm publish --dry-run --access public
          echo "✓ Dry run completed successfully"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Actual publish
      - name: Publish to npm
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != 'true')
        working-directory: router
        run: |
          npm publish --access public --provenance
          echo "✓ Published successfully to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Post-publish verification
      - name: Verify publication
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != 'true')
        working-directory: router
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")

          echo "Waiting for npm registry to update..."
          sleep 10

          # Check if package is available on npm
          if npm view "${PKG_NAME}@${PKG_VERSION}" version 2>/dev/null; then
            echo "✓ Package ${PKG_NAME}@${PKG_VERSION} is now available on npm"
          else
            echo "WARNING: Package not yet visible on npm registry (may take a few minutes)"
          fi
