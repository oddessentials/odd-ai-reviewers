# Contract: .trivyignore File Format

**Feature**: 001-security-cve-cleanup
**Date**: 2026-01-31

## Purpose

Defines the structured format for CVE exceptions in the .trivyignore file to enable automated age tracking and governance compliance.

---

## File Structure

```
# Trivy CVE Ignore List
#
# This file documents known CVEs that are accepted risks with justification.
# All CVEs require documented risk assessment and CODEOWNERS approval.
#
# Last reviewed: YYYY-MM-DD by [reviewer]
# Next review due: YYYY-MM-DD

# ============================================================================
# [SECTION HEADER - Category Name]
#
# [Section-level context about this group of exceptions]
# ============================================================================

# CVE-ID: CVE-YYYY-NNNNN
# Created: YYYY-MM-DD
# Expires: YYYY-MM-DD
# Package: package-name
# Version: x.y.z
# Fixed-In: a.b.c | N/A - awaiting upstream
# Risk: LOW | MEDIUM | HIGH
# Justification: Brief explanation of why exception is acceptable
# Upstream: https://github.com/org/repo/issues/123 | N/A
CVE-YYYY-NNNNN

[... additional entries ...]
```

---

## Header Block Contract

| Field           | Format                      | Required | Example                               |
| --------------- | --------------------------- | -------- | ------------------------------------- |
| Last reviewed   | `YYYY-MM-DD by [name/team]` | Yes      | `2026-01-31 by AI Review Router team` |
| Next review due | `YYYY-MM-DD`                | Yes      | `2026-04-30`                          |

---

## Entry Block Contract

### Comment Fields (Structured)

| Field         | Pattern                             | Required | Validation                   |
| ------------- | ----------------------------------- | -------- | ---------------------------- |
| CVE-ID        | `CVE-\d{4}-\d{4,}`                  | Yes      | Must match Trivy CVE format  |
| Created       | `\d{4}-\d{2}-\d{2}`                 | Yes      | Valid ISO 8601 date          |
| Expires       | `\d{4}-\d{2}-\d{2}`                 | Yes      | Must be Created + 180 days   |
| Package       | String                              | Yes      | Package or binary name       |
| Version       | Semver or version string            | Yes      | Currently vulnerable version |
| Fixed-In      | Semver or `N/A - awaiting upstream` | Yes      | Version with fix if known    |
| Risk          | `LOW\|MEDIUM\|HIGH`                 | Yes      | Risk level enum              |
| Justification | String (single line)                | Yes      | Non-empty explanation        |
| Upstream      | URL or `N/A`                        | No       | Tracking issue link          |

### CVE Entry Line

Single line containing only the CVE identifier:

```
CVE-YYYY-NNNNN
```

---

## Section Headers

Sections group related CVEs for readability. Use the format:

```
# ============================================================================
# [Section Name]
#
# [Optional multi-line description]
# ============================================================================
```

### Standard Sections

1. **OpenCode CLI Binary** - Go runtime CVEs in OpenCode
2. **Reviewdog Binary** - Go runtime CVEs in reviewdog (if any remain)
3. **npm transitive dependencies** - Build-time only npm CVEs
4. **Additional dependencies** - Other categorized exceptions

---

## Expiration Logic

```python
# Pseudocode for expiration check
def check_expiration(entry):
    today = date.today()
    if entry.expires <= today:
        return "EXPIRED - requires re-approval"
    elif entry.expires <= today + timedelta(days=30):
        return "WARNING - expires within 30 days"
    else:
        return "VALID"
```

---

## Example: Compliant Entry

```
# CVE-ID: CVE-2025-61729
# Created: 2026-01-31
# Expires: 2026-07-30
# Package: OpenCode CLI
# Version: 1.1.40
# Fixed-In: N/A - awaiting upstream
# Risk: LOW
# Justification: OpenCode runs isolated with stripped tokens; socket listener guards mitigate
# Upstream: https://github.com/anomalyco/opencode/issues/TBD
CVE-2025-61729
```

---

## Validation Script Interface

Future automation may validate this format:

```bash
# Proposed: scripts/validate-trivyignore.sh
# Exit 0: All entries valid
# Exit 1: Validation errors (missing fields, expired entries)
# Exit 2: Warnings (approaching expiration)
```

---

## Migration Notes

Existing .trivyignore entries without structured comments must be updated to include:

- Created date (use current date for existing entries)
- Expires date (Created + 180 days)
- All required comment fields

This is a one-time migration as part of the 001-security-cve-cleanup implementation.
