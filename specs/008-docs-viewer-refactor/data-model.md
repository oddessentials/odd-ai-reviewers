# Data Model: Documentation Viewer Refactor

**Feature**: 008-docs-viewer-refactor
**Date**: 2026-01-28

## Entities

### 1. Documentation Manifest

The manifest.json file is the sole source of truth for document discovery.

**Location**: `docs/viewer/manifest.json`

**Schema** (existing v2 format, unchanged):

```json
{
  "version": 2,
  "tree": [
    {
      "name": "architecture",
      "type": "folder",
      "path": "architecture",
      "children": [
        {
          "name": "overview.md",
          "type": "file",
          "path": "../architecture/overview.md"
        }
      ]
    },
    {
      "name": "index.md",
      "type": "file",
      "path": "../index.md"
    }
  ],
  "files": [
    {
      "name": "architecture/overview.md",
      "type": "file",
      "path": "../architecture/overview.md"
    },
    {
      "name": "index.md",
      "type": "file",
      "path": "../index.md"
    }
  ]
}
```

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| version | number | Manifest format version (currently 2) |
| tree | array | Hierarchical folder/file structure for sidebar display |
| files | array | Flat list of all files for allowlist validation |

**Validation Rules**:

- `version` must be >= 2
- `tree` and `files` must be non-empty arrays
- All `path` values must be relative (no absolute paths)
- All `path` values must resolve to files under `docs/`

### 2. Viewer Application State

Client-side state managed by `DocsViewer` object.

**Schema**:

```javascript
{
  // Current document being displayed
  currentFile: string | null,  // e.g., "getting-started/quick-start.md"

  // Compare mode state
  compareFile: string | null,  // Secondary pane document
  compareMode: boolean,        // Whether compare mode is active

  // Loaded manifest data
  manifestTree: array,         // Hierarchical tree for sidebar
  fileTree: array,             // Flat file list for validation
}
```

**State Transitions**:

```
Initial → Loading manifest → Loaded
                               ↓
                         Parse URL hash
                               ↓
              ┌────────────────┼────────────────┐
              ↓                ↓                ↓
         No hash         Valid hash       Invalid hash
              ↓                ↓                ↓
       Load index.md    Load target doc   Show "not found"
```

### 3. URL Hash State

Hash format: `#path/to/doc.md` or `#doc1.md|doc2.md` (compare mode)

**Schema**:

```javascript
// Parsed hash state
{
  primary: string | null,    // Primary pane document path
  secondary: string | null,  // Secondary pane document path (compare mode only)
}
```

**Parsing Rules**:

- Empty hash → `{ primary: null, secondary: null }` → load index.md
- `#doc.md` → `{ primary: 'doc.md', secondary: null }`
- `#doc1.md|doc2.md` → `{ primary: 'doc1.md', secondary: 'doc2.md' }` → enable compare mode

**Hash Reserved for Doc Routing**:

- Hash is ONLY used for document paths
- In-document heading anchors do NOT modify the URL hash
- Heading anchors use scroll-to-id behavior instead

### 4. Dev Server State

Server-side state for live reload functionality.

**Schema**:

```javascript
{
  // Connected SSE clients
  clients: Set<ServerResponse>,

  // File watcher instance
  watcher: FSWatcher,

  // Server configuration
  port: number,           // Default: 3000
  basePath: string,       // Default: '' (for GitHub Pages testing)

  // Manifest state
  lastManifestHash: string,  // For detecting actual changes
}
```

**Events**:
| Event | Source | Action |
|-------|--------|--------|
| File change (`.md`, `.js`, `.css`, `.html`) | chokidar | Notify all SSE clients |
| File add (`.md`) | chokidar | Regenerate manifest, notify clients |
| File remove (`.md`) | chokidar | Regenerate manifest, notify clients |
| Client connect | HTTP `/` | Add to clients Set |
| Client disconnect | HTTP close | Remove from clients Set |
| Port in use | Server error | Exit with error message including port |

## Relationships

```
┌─────────────────┐       reads        ┌─────────────────┐
│  Dev Server     │ ────────────────→  │  manifest.json  │
│  (Node.js)      │                    │  (source of     │
│                 │ ←──────────────── │   truth)        │
│                 │      regenerates   └─────────────────┘
└────────┬────────┘                           ↑
         │                                    │
    serves│                                   │ generated by
         │                                    │
         ↓                                    │
┌─────────────────┐       fetches      ┌─────────────────┐
│  Browser        │ ────────────────→  │  generate-docs- │
│  (app.js)       │                    │  manifest.cjs   │
│                 │                    └─────────────────┘
│                 │       validates          │
│                 │ ────────────────→        │
│                 │       paths against      │
│                 │       manifest.files     │
└─────────────────┘                          │
         ↑                                   │
         │ SSE reload                        │
         │ signal                            │
         │                                   │
┌────────┴────────┐       watches      ┌─────────────────┐
│  SSE Client     │ ←────────────────  │  docs/**/*.md   │
│  (injected)     │                    │  docs/viewer/*  │
└─────────────────┘                    └─────────────────┘
```

## Document Count Calculation

**Current (broken)**:

```javascript
this.fileTree.length; // Returns 8 (top-level tree items only)
```

**Fixed**:

```javascript
// Use flat files array from manifest
this.fileTree.length; // Returns 33 (actual file count)

// Or count recursively from tree if needed
function countFiles(items) {
  return items.reduce((count, item) => {
    if (item.type === 'file') return count + 1;
    if (item.children) return count + countFiles(item.children);
    return count;
  }, 0);
}
```

**Note**: The manifest already provides both `tree` (hierarchical) and `files` (flat) arrays. The viewer currently uses `fileTree` which is populated from `manifest.files`, so the count should be correct. The bug is in the intro display which uses `this.fileTree.length` after setting `this.fileTree = manifest.files`. Need to verify the actual data flow.

## Security Model (Preserved)

1. **File Allowlist**: Only paths in `manifest.files` can be loaded
2. **Content Sanitization**: DOMPurify with strict tag/attribute allowlist
3. **Path Validation**: No `..` traversal, no absolute paths accepted
4. **CSP Headers**: Script sources restricted to self + cdn.jsdelivr.net
5. **SSE Script Isolation**: Injected at response time, never written to files
