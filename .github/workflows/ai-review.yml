# AI Review Reusable Workflow
# Callable via workflow_call from target repositories

name: AI Review

on:
  workflow_call:
    inputs:
      target_repo:
        description: 'Target repository (owner/repo)'
        required: true
        type: string
      target_ref:
        description: 'Git ref to checkout (SHA or branch)'
        required: true
        type: string
      pr_number:
        description: 'PR number (if applicable)'
        required: false
        type: number
      base_ref:
        description: 'Base ref for diff (defaults to main)'
        required: false
        type: string
        default: 'main'
      runs_on:
        description: 'Runner labels as JSON (e.g., "ubuntu-latest" or ["self-hosted","linux"])'
        required: false
        type: string
        default: '"ubuntu-latest"'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key (for opencode or pr_agent)'
        required: false
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key (for opencode with Claude models)'
        required: false
      OLLAMA_BASE_URL:
        description: 'Ollama server URL for local LLM'
        required: false

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout review router
        uses: actions/checkout@v4
        with:
          repository: oddessentials/odd-ai-reviewers
          path: router

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_ref }}
          path: target
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: router/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: router/pnpm-lock.yaml

      - name: Install router dependencies
        working-directory: router
        run: pnpm install --frozen-lockfile

      - name: Build router
        working-directory: router
        run: pnpm build

      # Runtime smoke test - verify toolchain as actual job user
      - name: Verify toolchain
        run: |
          echo "=== Toolchain Smoke Test ==="
          echo "User: $(whoami)"
          echo "Shell: $SHELL"
          echo "PATH: $PATH"
          which semgrep 2>/dev/null && semgrep --version || echo "semgrep: will install"

      - name: Install Semgrep
        run: pip3 install semgrep==1.148.0

      - name: Determine base SHA
        id: base
        working-directory: target
        run: |
          if [ -n "${{ github.event.pull_request.base.sha }}" ]; then
            echo "sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=$(git rev-parse origin/${{ inputs.base_ref }})" >> $GITHUB_OUTPUT
          fi

      - name: Run AI Review
        working-directory: router
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
        run: |
          OWNER=$(echo "${{ inputs.target_repo }}" | cut -d'/' -f1)
          REPO=$(echo "${{ inputs.target_repo }}" | cut -d'/' -f2)

          node router/dist/main.js review \
            --repo ../target \
            --base ${{ steps.base.outputs.sha }} \
            --head ${{ inputs.target_ref }} \
            --owner "$OWNER" \
            --repo-name "$REPO" \
            ${{ inputs.pr_number && format('--pr {0}', inputs.pr_number) || '' }}

      - name: Upload review artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-results
          path: |
            router/review-*.json
            router/review-*.md
          retention-days: 7
